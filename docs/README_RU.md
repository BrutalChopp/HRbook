# Документация к проекту QR Library Telegram Bot

Данный бот позволяет управлять бумажной библиотекой с помощью QR‑кодов.
Он написан на Python с использованием фреймворка `python-telegram-bot`.

## Установка

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Скопируйте файл `.env.example` в `.env` и укажите токен бота и ID администраторов.

По умолчанию бот работает с базой PostgreSQL. Для локального запуска можно
использовать SQLite, задав переменную окружения `DB_ENGINE=sqlite` и указав путь
к файлу базы в `DB_NAME`.

Подробнее о доступных переменных описано в [ENVIRONMENT_RU.md](ENVIRONMENT_RU.md).

## Запуск

Инициализация базы выполняется автоматически при старте. Запустите:

```bash
python main.py
```

Бот должен иметь доступ к сети для обращения к `api.telegram.org`.

## Основные возможности

- Регистрация пользователей через команду `/start`.
- Сканирование QR‑кодов для выдачи и возврата книг.
- Просмотр списка своих книг и всех книг в библиотеке.
- Поддержка нескольких офисов; пользователь выбирает офис при регистрации.
- Права администратора можно задать глобально или для конкретного офиса.

## Функции администратора

Администраторы получают дополнительные действия в меню:

- Добавление книг в библиотеку.
- Генерация отчёта по всем книгам.
- Сброс статуса книги и удаление пользователей.
- Просмотр списка всех зарегистрированных пользователей.

## Избежание ошибки 409

Telegram не допускает одновременную работу нескольких ботов с одним токеном.
Чтобы предотвратить ошибку `409 Conflict`, при запуске создаётся файл блокировки
`/tmp/hrbook_bot.lock`. Если бот завершился некорректно, удалите этот файл
перед повторным запуском.

## Тесты

Для запуска набора автоматических тестов используйте:

```bash
pytest
```

Тесты работают с SQLite и не требуют отдельной настройки базы.
